<html>
<head>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
	<!-- Load the d3 library. -->
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<style>
	body { font-family: "Open Sans"; } div { margin: 30px; }
	.container {
		border-bottom: 1px black solid;
	}
	#graph{
		margin-left: 100px;
	}
	#graph svg{
		padding-left: 50px;
	}
	.bar_pass{
		float: right;
		margin-top: 70px;
		display: inline-block;
	}
	</style>
</head>

<body>
<h1>Domestic Flights in 2014 Quarter 1</h1>
<div>Data from the <a href="http://www.transtats.bts.gov/DL_SelectFields.asp?Table_ID=247&DB_Short_Name=Origin%20and%20Destination%20Survey">Bureau of Transportation Statistics</a>.</div>

<!-- SVG element -->
<div class="container">
	<div class="description">
		<h3> Flight Fares By Cities </h3>
	</div>
	<div class="map" id="fareCities">
	</div>
	<div class="description">
		<h3> Incoming Flights </h3>
	</div>
	<div class="map" id="pass">
	</div>
	<div class="description">
		<h3> Outgoing Flights </h3>
	</div>
	<div class="map" id="pass_out">
	</div>

	
</div>
<div class="container">
	<div class="description">
		<h3> Difference between Outgoing and Incoming Flights</h3>
	</div>
	<div class="map" id="pass_diff">
	</div>	
</div>
<div class="container">
	<div class="description">
		<h3>Market Fare of Incoming Flights</h3>
	</div>
	<div class="map" id="fare">
	</div>
</div>
<div class="container">
	<div class="description">
		<h3>Incoming vs. Outiong Flights</h3>
	</div>
	<div class="map" id="graph">
	</div>
</div>

<svg>
    <defs>
        <linearGradient id="Gradient-1"
             x1="0" y1="100%" x2="0" y2="0">
            <stop offset="0%" stop-color="#f5f5f5" />
            <stop offset="100%" stop-color="#5ab4ac" />
        </linearGradient>
    
        <linearGradient id="Gradient-2"
             x1="0" y1="100%" x2="0" y2="0">
            <stop offset="0%" stop-color="#fbf7ef" />
            <stop offset="100%" stop-color="#d8b365" />
        </linearGradient>

        <linearGradient id="Gradient-3"
             x1="0" y1="100%" x2="0" y2="0">
            <stop offset="0%" stop-color="#d8b365" />
            <stop offset="50%" stop-color="#f5f5f5" />
            <stop offset="100%" stop-color="#5ab4ac" />
        </linearGradient>

        <linearGradient id="Gradient-4"
             x1="0" y1="100%" x2="0" y2="0">
            <stop offset="0%" stop-color="#f5f5f5" />
            <stop offset="100%" stop-color="#5ab4ac" />
        </linearGradient>

    </defs>
</svg>

<script>
	//create svg
	var width = 960,
		height = 500;
				
	//map variables
	var projection = d3.geo.albersUsa();
	var path = d3.geo.path().projection(projection); //path of USA

	var statesCoord;
	var flights;
	
	d3.json("us.json", function(error, shapes) {	
		statesCoord = topojson.feature(shapes, shapes.objects.states).features; //long/lat coordinates				
		
		// draw bubble chart
		d3.csv("flightsfare_small.csv", function(error, rows) {
			var svg = d3.select("#fareCities").append("svg")
			.attr("width", width)
			.attr("height", height);
			
			var statePaths = svg.append("g");
			
			statePaths.selectAll("path").data(statesCoord).enter()
			.append("path").attr("d", path)
			.style({"fill":"#ccc", "stroke":"#ccc"});

			var bubbles = svg.selectAll(".dot").data(rows).enter().append("circle");

			bubbles.attr("transform", function(d) {
    			return "translate(" + projection([d.long, d.lat]) + ")"
    		})
			.attr("r",function(d) {
				var r = (d.avg_fare-100)/15+2;
				return r;
			})
			.attr("opacity", 0.5);
		});

		//process data
		d3.csv("flights_processed.csv", function(error, rows) {						
			//key-value pairs with FIPS as key
			flights = d3.map(rows,
				function (d) {
					return d.FIPS;
				}
			);
			
			//pass-in data
			var passengerInScale = d3.scale.linear()
			.domain(d3.extent(rows, function(d) {return Number(d.passIn);}))
			.range(["#f5f5f5", "#5ab4ac"]);
			
			//draw states	
			var svg = d3.select("#pass").append("svg")
			.attr("width", width)
			.attr("height", height);
			
			var statePaths = svg.append("g");
			
			statePaths.selectAll("path").data(statesCoord).enter()
			.append("path").attr("d", path)
			.style("fill", function(state) {	
				var stateData = flights.get(state.id);
				if(stateData) {
					return passengerInScale(stateData.passIn); //scale based on pass-in data
				}
			})
			.style("stroke", "#ccc");


			// add state name
			statePaths.selectAll("text").data(statesCoord).enter()
			.append("text")
			.attr("x", function(d){
				if(!isNaN(path.centroid(d)[0]))
					return path.centroid(d)[0];
				else
					return 9999999;
			})
			.attr("y", function(d){
				if(!isNaN(path.centroid(d)[1]))
					return path.centroid(d)[1];
				else
					return 9999999;
			})
			.html(function(state){
				if(flights.get(state.id))
				    return flights.get(state.id)['State'];
				else return '';
			})
			.style("font-size", "10px");


			//draw color bar
			var svg = d3.select("#pass").append("svg")
			.attr("width",70)
			.attr("height",400)
			.attr("class", "bar_pass")
			.append("rect")
			.attr("width",30)
			.attr("height",400)
			.style("fill","url(#Gradient-1)");


			//pass-out data
			var passengerOutScale = d3.scale.linear()
			.domain(d3.extent(rows, function(d) {return Number(d.passOut);}))
			.range(["#fbf7ef", "#d8b365"]);
			
			//draw states	
			var svg = d3.select("#pass_out").append("svg")
			.attr("width", width)
			.attr("height", height);
			
			var statePaths = svg.append("g");
			
			statePaths.selectAll("path").data(statesCoord).enter()
			.append("path").attr("d", path)
			.style("fill", function(state) {	
				var stateData = flights.get(state.id);
				if(stateData) {
					return passengerOutScale(stateData.passOut); //scale based on pass-out data
				}
			})
			.style("stroke", "#ccc");



			// add state name
			statePaths.selectAll("text").data(statesCoord).enter()
			.append("text")
			.attr("x", function(d){
				if(!isNaN(path.centroid(d)[0]))
					return path.centroid(d)[0];
				else
					return 9999999;
			})
			.attr("y", function(d){
				if(!isNaN(path.centroid(d)[1]))
					return path.centroid(d)[1];
				else
					return 9999999;
			})
			.html(function(state){
				if(flights.get(state.id))
				    return flights.get(state.id)['State'];
				else return '';
			})
			.style("font-size", "10px");



			var svg = d3.select("#pass_out").append("svg")
			.attr("width",70)
			.attr("height",400)
			.attr("class", "bar_out")
			.append("rect")
			.attr("width",30)
			.attr("height",400)
			.style("fill","url(#Gradient-2)");

			
			//pass-diff data
			var passengerDiffScale = d3.scale.linear().domain([d3.min(rows, function(d) {return Number(d.passDif);}), 0, d3.max(rows, function(d) {return Number(d.passDif);})]).range(["#d8b365", "#f5f5f5", "#5ab4ac"]);
			
			//draw states	
			var svg = d3.select("#pass_diff").append("svg")
			.attr("width", width)
			.attr("height", height);
			
			var statePaths = svg.append("g");
			
			statePaths.selectAll("path").data(statesCoord).enter()
			.append("path").attr("d", path)
			.style("fill", function(state) {	
				var stateData = flights.get(state.id);
				if(stateData) {
					return passengerDiffScale(stateData.passDif); //scale based on pass-dif data
				}
			})
			.style("stroke", "#ccc");


			// add state name
			statePaths.selectAll("text").data(statesCoord).enter()
			.append("text")
			.attr("x", function(d){
				if(!isNaN(path.centroid(d)[0]))
					return path.centroid(d)[0];
				else
					return 9999999;
			})
			.attr("y", function(d){
				if(!isNaN(path.centroid(d)[1]))
					return path.centroid(d)[1];
				else
					return 9999999;
			})
			.html(function(state){
				if(flights.get(state.id))
				    return flights.get(state.id)['State'];
				else return '';
			})
			.style("font-size", "10px");


			//draw color bar
			var svg = d3.select("#pass_diff").append("svg")
			.attr("width",70)
			.attr("height",400)
			.attr("class", "bar_pass")
			.append("rect")
			.attr("width",30)
			.attr("height",400)
			.style("fill","url(#Gradient-3)");

			


			//fare data
			var passengerFareScale = d3.scale.linear().domain([222, d3.max(rows, function(d) {return Number(d.fare);})]).range(["#f5f5f5", "#5ab4ac"]); //min is outlier so use second smallest
			
			//draw states	
			var svg = d3.select("#fare").append("svg")
			.attr("width", width)
			.attr("height", height);
			
			statePaths = svg.append("g");
			
			statePaths.selectAll("path").data(statesCoord).enter()
			.append("path").attr("d", path)
			.style("fill", function(state) {	
				var stateData = flights.get(state.id);
				if(stateData) {
					return passengerFareScale(stateData.fare); //scale based on market fare data
				}
			})
			.style("stroke", "#ccc");

<<<<<<< HEAD

=======
			// add state name
			statePaths.selectAll("text").data(statesCoord).enter()
			.append("text")
			.attr("x", function(d){
				if(!isNaN(path.centroid(d)[0]))
					return path.centroid(d)[0];
				else
					return 9999999;
			})
			.attr("y", function(d){
				if(!isNaN(path.centroid(d)[1]))
					return path.centroid(d)[1];
				else
					return 9999999;
			})
			.html(function(state){
				if(flights.get(state.id))
				    return flights.get(state.id)['State'];
				else return '';
			})
			.style("font-size", "10px");
>>>>>>> origin/master

			var svg = d3.select("#fare").append("svg")
			.attr("width",70)
			.attr("height",400)
			.attr("class", "bar_fare")
			.append("rect")
			.attr("width",30)
			.attr("height",400)
			.style("fill","url(#Gradient-4)");


			
			//in v out comparison
			var padding = 60;
			var xScale = d3.scale.linear().domain(d3.extent(rows, function(d) {return Number(d.passIn);})).range([padding, 800-padding]);
			var yScale = d3.scale.linear().domain(d3.extent(rows, function(d) {return Number(d.passOut);})).range([600-padding, padding]);
			var rScale = d3.scale.sqrt().domain(d3.extent(rows, function(d) {return Number(d.fare);})).range([5, 25]);
			
			var svg = d3.select("#graph").append("svg").attr("height", 600).attr("width", 800);
			
			//draw scale
			var xAxis = d3.svg.axis().scale(xScale)
			.orient("bottom");
			var yAxis = d3.svg.axis().scale(yScale)
			.orient("left");
			
			svg.append("g").attr("class", "axis")
			.attr("transform", "translate(0," + (600 - padding) + ")")
			.call(xAxis);
			svg.append("g").attr("class", "axis")
			.attr("transform", "translate(" + padding + ",0)")
			.call(yAxis);
			
			//draw circles
			var circles = svg.selectAll().data(rows).enter().append("circle");
			
			circles.attr("cx", function(d) { return xScale(d.passIn); })
			.attr("cy", function(d) { return yScale(d.passOut); })
			.attr("r", function(d) {return rScale(d.fare);})
			.attr("opacity", 0.3);
			
		});
	});
</script>

</body>
</html>